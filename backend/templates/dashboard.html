{% extends "base.html" %}

{% block title %}Dashboard - Separa√ß√£o PMCELL{% endblock %}

{% block extra_head %}
<style>
    /* Fase 30: Anima√ß√µes para atualiza√ß√µes em tempo real */

    /* Anima√ß√£o de fade-in para novos cards */
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .fade-in-animation {
        animation: fadeIn 0.5s ease-out;
    }

    /* Anima√ß√£o de fade-out para cards removidos */
    @keyframes fadeOut {
        from {
            opacity: 1;
            transform: scale(1);
        }
        to {
            opacity: 0;
            transform: scale(0.95);
        }
    }

    .fade-out-animation {
        animation: fadeOut 0.5s ease-in forwards;
    }

    /* Anima√ß√£o de pulsa√ß√£o para atualiza√ß√£o de progresso */
    @keyframes progressPulse {
        0%, 100% {
            box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
        }
        50% {
            box-shadow: 0 0 0 8px rgba(59, 130, 246, 0);
        }
    }

    .progress-update-animation {
        animation: progressPulse 0.5s ease-out;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Dashboard - PMCELL</h1>
                    <p class="text-sm text-gray-600">Separa√ß√£o de Pedidos</p>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- Bot√£o Painel de Administra√ß√£o (vis√≠vel apenas para ADMINISTRADOR) -->
                    {% if usuario.is_admin %}
                    <a href="{% url 'admin_panel' %}" class="inline-flex items-center px-4 py-2 bg-gray-700 text-white text-sm font-medium rounded-lg hover:bg-gray-800 transition-colors shadow-sm">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                        </svg>
                        üë• Gerenciar Usu√°rios
                    </a>
                    {% endif %}
                    <!-- Bot√£o Painel de Compras (vis√≠vel apenas para COMPRADORA) -->
                    {% if usuario.tipo == 'COMPRADORA' %}
                    <a href="{% url 'painel_compras' %}" class="inline-flex items-center px-4 py-2 bg-orange-600 text-white text-sm font-medium rounded-lg hover:bg-orange-700 transition-colors shadow-sm">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                        üõí Painel de Compras
                    </a>
                    {% endif %}
                    <!-- Bot√£o M√©tricas (Fase 33) -->
                    <a href="{% url 'metricas' %}" class="inline-flex items-center px-4 py-2 bg-purple-600 text-white text-sm font-medium rounded-lg hover:bg-purple-700 transition-colors shadow-sm">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        üìä M√©tricas
                    </a>
                    <!-- Bot√£o Criar Novo Pedido -->
                    <a href="{% url 'upload_orcamento' %}" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors shadow-sm">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        Criar Novo Pedido
                    </a>
                    <!-- User Dropdown -->
                    {% include "partials/_user_dropdown.html" %}
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- T√≠tulo e Filtros -->
        <div class="mb-6">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900">Pedidos em Separa√ß√£o</h2>
                    <p class="mt-1 text-sm text-gray-600">{{ pedidos.count }} pedido(s) aguardando separa√ß√£o</p>
                </div>
            </div>

            <!-- Barra de Busca e Filtros - Fase 19 -->
            <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Campo de Busca -->
                    <div>
                        <label for="search" class="block text-sm font-medium text-gray-700 mb-2">
                            <svg class="inline h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                            Buscar Pedido
                        </label>
                        <input
                            type="text"
                            id="search"
                            name="search"
                            placeholder="N√∫mero do or√ßamento ou nome do cliente..."
                            value="{{ search_query }}"
                            hx-get="{% url 'dashboard' %}"
                            hx-trigger="keyup changed delay:500ms"
                            hx-target="#pedidos-grid"
                            hx-swap="outerHTML"
                            hx-include="[name='vendedor']"
                            hx-indicator="#loading-spinner"
                            class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm px-4 py-2 border"
                        />
                    </div>

                    <!-- Filtro por Vendedor -->
                    <div>
                        <label for="vendedor" class="block text-sm font-medium text-gray-700 mb-2">
                            <svg class="inline h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                            Filtrar por Vendedor
                        </label>
                        <select
                            id="vendedor"
                            name="vendedor"
                            hx-get="{% url 'dashboard' %}"
                            hx-trigger="change"
                            hx-target="#pedidos-grid"
                            hx-swap="outerHTML"
                            hx-include="[name='search']"
                            hx-indicator="#loading-spinner"
                            class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm px-4 py-2 border"
                        >
                            <option value="">Todos os vendedores</option>
                            {% for v in vendedores %}
                                <option value="{{ v.id }}" {% if vendedor_id == v.id|stringformat:"s" %}selected{% endif %}>
                                    {{ v.nome }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card de M√©tricas de Tempo - Fase 20 -->
        {# Fase 20: M√©tricas de tempo m√©dio de separa√ß√£o #}
        {% include "partials/_card_metricas_tempo.html" %}

        <!-- Grid de Pedidos (Partial) - Fase 19 -->
        {# Fase 19: Grid refatorado em partial para suportar HTMX #}
        {% include "partials/_pedidos_grid.html" %}
    </main>
</div>

{# Fase 30: WebSocket para Atualiza√ß√µes em Tempo Real #}
<script>
(function() {
    'use strict';

    // Configura√ß√£o do WebSocket
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/dashboard/`;
    let socket = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 10;
    const reconnectDelay = 3000; // 3 segundos

    // Conectar ao WebSocket
    function connect() {
        console.log('[WebSocket] Conectando...', wsUrl);

        try {
            socket = new WebSocket(wsUrl);

            socket.onopen = function(e) {
                console.log('[WebSocket] Conectado com sucesso!');
                reconnectAttempts = 0;
            };

            socket.onmessage = function(event) {
                console.log('[WebSocket] Mensagem recebida:', event.data);

                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketEvent(data);
                } catch (error) {
                    console.error('[WebSocket] Erro ao parsear mensagem:', error);
                }
            };

            socket.onclose = function(event) {
                console.log('[WebSocket] Conex√£o fechada:', event.code, event.reason);

                // Tentar reconectar
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    console.log(`[WebSocket] Tentando reconectar (${reconnectAttempts}/${maxReconnectAttempts})...`);
                    setTimeout(connect, reconnectDelay);
                } else {
                    console.error('[WebSocket] M√°ximo de tentativas de reconex√£o atingido.');
                }
            };

            socket.onerror = function(error) {
                console.error('[WebSocket] Erro:', error);
            };
        } catch (error) {
            console.error('[WebSocket] Erro ao criar conex√£o:', error);
        }
    }

    // Manipular eventos WebSocket
    function handleWebSocketEvent(data) {
        const { type, pedido_id, progresso, itens_separados, total_itens } = data;

        switch (type) {
            case 'pedido_criado':
                handlePedidoCriado(pedido_id);
                break;

            case 'item_separado':
                handleItemSeparado(pedido_id, progresso, itens_separados, total_itens);
                break;

            case 'pedido_finalizado':
                handlePedidoFinalizado(pedido_id);
                break;

            default:
                console.warn('[WebSocket] Tipo de evento desconhecido:', type);
        }
    }

    // Handler: Pedido Criado
    function handlePedidoCriado(pedidoId) {
        console.log('[WebSocket] Pedido criado:', pedidoId);

        // Usar HTMX para carregar novo card via AJAX
        const url = `/pedidos/${pedidoId}/card/`;
        const container = document.querySelector('#pedidos-grid');

        if (container) {
            htmx.ajax('GET', url, {
                target: '#pedidos-grid',
                swap: 'afterbegin', // Adicionar no in√≠cio da lista
                select: 'div' // Selecionar apenas o card retornado
            }).then(() => {
                console.log('[WebSocket] Novo card adicionado ao dashboard');

                // Adicionar anima√ß√£o fade-in ao novo card
                const newCard = container.firstElementChild;
                if (newCard && newCard.classList) {
                    newCard.classList.add('fade-in-animation');
                }
            }).catch(error => {
                console.error('[WebSocket] Erro ao carregar card:', error);
            });
        }
    }

    // Handler: Item Separado (atualizar progresso)
    function handleItemSeparado(pedidoId, progresso, itens_separados, total_itens) {
        console.log('[WebSocket] Item separado - Pedido:', pedidoId, 'Progresso:', progresso + '%', 'Itens:', itens_separados + '/' + total_itens);

        // Encontrar o card do pedido e atualizar barra de progresso
        const cardSelector = `[data-pedido-id="${pedidoId}"]`;
        const card = document.querySelector(cardSelector);

        if (card) {
            // Atualizar barra de progresso
            const progressBar = card.querySelector('.progress-bar');
            const progressText = card.querySelector('.progress-text');

            if (progressBar) {
                progressBar.style.width = progresso + '%';
                progressBar.classList.add('progress-update-animation');

                // Remover classe de anima√ß√£o ap√≥s completar
                setTimeout(() => {
                    progressBar.classList.remove('progress-update-animation');
                }, 500);
            }

            if (progressText) {
                progressText.textContent = progresso + '%';
            }

            // Atualizar contador de itens (X/Y itens separados)
            const contadorItens = card.querySelector('.contador-itens');
            if (contadorItens) {
                contadorItens.textContent = itens_separados + '/' + total_itens + ' itens separados';
            }

            console.log('[WebSocket] Progresso e contador atualizados');
        } else {
            console.warn('[WebSocket] Card do pedido n√£o encontrado:', pedidoId);
        }
    }

    // Handler: Pedido Finalizado (remover card)
    function handlePedidoFinalizado(pedidoId) {
        console.log('[WebSocket] Pedido finalizado:', pedidoId);

        // Encontrar e remover o card do pedido
        const cardSelector = `[data-pedido-id="${pedidoId}"]`;
        const card = document.querySelector(cardSelector);

        if (card) {
            // Adicionar anima√ß√£o de fade-out
            card.classList.add('fade-out-animation');

            // Remover do DOM ap√≥s anima√ß√£o
            setTimeout(() => {
                card.remove();
                console.log('[WebSocket] Card removido do dashboard');
            }, 500); // Dura√ß√£o da anima√ß√£o
        } else {
            console.warn('[WebSocket] Card do pedido n√£o encontrado:', pedidoId);
        }
    }

    // Iniciar conex√£o WebSocket ao carregar a p√°gina
    connect();

    // Fechar conex√£o ao sair da p√°gina
    window.addEventListener('beforeunload', function() {
        if (socket && socket.readyState === WebSocket.OPEN) {
            socket.close();
        }
    });
})();
</script>
{% endblock %}
